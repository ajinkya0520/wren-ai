services:
  kafka:
    image: bitnamilegacy/kafka:3.9.0
    ports:
      - 9092:9092
    environment:
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_DELETE_TOPIC_ENABLE=true
      - KAFKA_ENABLE_KRAFT=true
      - KAFKA_KRAFT_CLUSTER_ID=AAAAAAAAAAAAAAAAAAAAAA
      - KAFKA_CFG_BROKER_ID=1
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=IB
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,BROKER:PLAINTEXT,IB:PLAINTEXT
      - KAFKA_CFG_LISTENERS=CONTROLLER://:9093,BROKER://:9092,IB://:9094
      - KAFKA_ADVERTISED_LISTENERS=BROKER://kafka:9092,IB://:9094
      - BITNAMI_DEBUG=yes
    restart: always

#  grafana:
#    image: grafana/grafana:9.4.3
#    environment:
#      - GF_INSTALL_PLUGINS=vertamedia-clickhouse-datasource
#    ports:
#      - 3000:3000
#    restart: always
#    volumes:
#      - ./grafana/datasources-ch.yml:/etc/grafana/provisioning/datasources/datasources-ch.yml
#      - ./grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml
#      - ./grafana/dashboards:/var/lib/grafana/dashboards

#  prometheus:
#    image: prom/prometheus:v3.0.1
#    ports:
#      - 9090:9090
#    restart: always
#    volumes:
#      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml

  goflow2:
    build:
      context: ../../
      dockerfile: Dockerfile
      args:
        VERSION: compose
        LDFLAGS: -X main.version=compose
    image: netsampler/goflow2:latest
    depends_on:
      - kafka
    ports:
      - 8080:8080
      - 6343:6343/udp
      - 2055:2055/udp
      - 4739:4739/udp
    restart: always
    command:
      - -transport.kafka.brokers=kafka:9092
      - -transport=kafka
      - -transport.kafka.topic=flows
      - -format=bin
      #- -listen=sflow://:6343,netflow://:2055, ipfix://4739
      #- -input=ipfix
      #- -listen=0.0.0.0:4739
      #- -transport=stdout
      #- -format=json

  db:
    build:
      context: ./clickhouse
      dockerfile: Dockerfile.clickhouse
    #image: clickhouse/clickhouse-server:24.11.1.2557-alpine
    ports:
      - 8123:8123
      - 9000:9000
    volumes:
      - ./clickhouse:/docker-entrypoint-initdb.d/
      - ./clickhouse/flow.proto:/var/lib/clickhouse/format_schemas/flow.proto
      - ./clickhouse/protocols.csv:/var/lib/clickhouse/user_files/protocols.csv
      - ./clickhouse/generate_clickhouse_schema.py:/var/lib/clickhouse/generate_clickhouse_schema.py
      - ./flink-job/field_mapping.json:/var/lib/clickhouse/field_mapping.json
      - ./clickhouse/enriched_flows_table.py:/var/lib/clickhouse/enriched_flows_table.py
      - ./clickhouse/new_field_mapping.json:/var/lib/clickhouse/new_field_mapping.json
    depends_on:
      - kafka

  superset-custom:
    build:
      context: ./superset/
      dockerfile: Dockerfile.custom
    #image: apache/superset:latest
    ports:
      - 8088:8088
    environment:
      - SUPERSET_SECRET_KEY=AVS9jBiie5xYz6trAQ20oNFri79C3T7QPIaNgDT79KqL1mhxuz+F2wwa
      - DATABASE_URL=clickhouse+http://default:@db:8123/default
    volumes:
      - ./superset/superset:/app/pythonpath
    depends_on:
      - db
    restart: always

#  superset:
#    image: apache/superset:latest
#    ports:
#      - 8088:8088
#    environment:
#      - SUPERSET_SECRET_KEY=AVS9jBiie5xYz6trAQ20oNFri79C3T7QPIaNgDT79KqL1mhxuz+F2wwa
#      - DATABASE_URL=clickhouse+http://default:@db:8123/default
#    volumes:
#      - ./superset:/app/pythonpath
#    depends_on:
#      - db
#    restart: always

#  risingwave:
#    image: risingwavelabs/risingwave:latest
#    ports:
#      - 4566:4566
#      - 5691:5691
#    environment:
#      - RW_BLOCK_CACHE_CAPACITY_MB=2048
#      - RW_META_CACHE_CAPACITY_MB=2048
#      - RW_SHARED_BUFFER_CAPACITY_MB=2048
#      - RW_DEDICATED_RUNTIME=true
#      - RW_TELEMETRY_TRACKING_ID=b95c30a9-e682-4aee-be85-527dc2472462
#      - RW_IN_MEMORY_CACHE_CAPACITY_MB=2048
#    restart: always

  jobmanager:
    image: flink:1.17.1
    command: jobmanager
    ports:
      - "8081:8081"
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
    volumes:
      - ./flink-job/target:/opt/flink/usrlib
      - ./ipfixgen/geolite:/opt/flink/geolite
      - ./flink-job/field_mapping.json:/opt/flink/config/field_mapping.json
      - ./flink-job/ipam_enrichment.csv:/opt/flink/config/ipam_enrichment.csv

  taskmanager:
    image: flink:1.17.1
    command: taskmanager
    depends_on:
      - jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 4
    volumes:
      - ./flink-job/target:/opt/flink/usrlib
      - ./ipfixgen/geolite:/opt/flink/geolite
      - ./flink-job/field_mapping.json:/opt/flink/config/field_mapping.json
      - ./flink-job/ipam_enrichment.csv:/opt/flink/config/ipam_enrichment.csv

  flask-api:
    build:
      context: ./flask-api
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=development
    restart: always

#  ollama:
#    build:
#      context: ./ollama
#    ports:
#      - "11434:11434"
#    volumes:
#      - ollama_data:/root/.ollama
#    restart: always

  cube-store:
    image: cubejs/cubestore:latest
    ports:
      - "3030:3030"
    volumes:
      - cube-store:/cube-store
    restart: always

  cube:
    image: cubejs/cube:latest
    ports:
      - "4000:4000"   # Cube Playground
      - "15432:15432"   # SQL API
    environment:
      - CUBEJS_DB_TYPE=clickhouse
      - CUBEJS_DB_HOST=db
      - CUBEJS_DB_PORT=8123
      - CUBEJS_DB_NAME=default
      - CUBEJS_DB_USER=default
      - CUBEJS_DB_PASS=
      - CUBEJS_SQL_API=true
      - CUBEJS_SQL_PORT=15432
      - CUBEJS_SQL_USER=cube
      - CUBEJS_SQL_PASSWORD=cube
      - CUBEJS_API_SECRET=1cba409bc2e7dbf87a816fcea3af197551395b6591fcfa8ddc695fa33a04f808
      - CUBEJS_CUBESTORE_HOST=cube-store
      - CUBEJS_DEV_MODE=true
    volumes:
      - ./cube:/cube/conf
    depends_on:
      - db
      - cube-store

#  wrenai:
#    image: wrenai/wrenai:latest
#    ports:
#      - "8089:8089" # WrenAI API/UI port
#    environment:
#      - WREN_DATABASES=clickhouse
#      - WREN_CLICKHOUSE_HOST=db
#      - WREN_CLICKHOUSE_PORT=8123
#      - WREN_CLICKHOUSE_USER=default
#      - WREN_CLICKHOUSE_PASSWORD=
#      - WREN_CLICKHOUSE_DATABASE=default
#    depends_on:
#      - db
#    restart: always

#  qdrant:
#    image: qdrant/qdrant:latest
#    ports:
#      - "6333:6333"
#    volumes:
#      - ./qdrant_storage:/qdrant/storage
#    restart: always

#  wren-ai-service:
#    build:
#      context: .
#      dockerfile: Dockerfile.wren
#    image: custom-wren-ai:latest
    #image: ghcr.io/canner/wren-ai-service:latest
#    ports:
#      - "5555:5555"
#    environment:
#      - OPENAI_API_KEY=sk-abcdef1234567890abcdef1234567890abcdef12
#      - WREN_DB_TYPE=clickhouse
#      - WREN_DB_HOST=db
#      - WREN_DB_PORT=9000
#      - WREN_DB_NAME=default
#      - WREN_DB_USER=default
#      - WREN_DB_PASSWORD=
#     - QDRANT_URL=http://qdrant:6333
      #- DISABLE_QDRANT_CHECK=true
      #- QDRANT_HEALTH_ENDPOINT=/readyz
#    depends_on:
#      - db
#     #- qdrant
#    restart: on-failure

  wren-bootstrap:
    image: ghcr.io/canner/wren-bootstrap:latest
    restart: on-failure
    environment:
      - DATA_PATH=/app/data
    volumes:
      - wren-data:/app/data
    command: /bin/sh /app/init.sh

  wren-engine:
    image: ghcr.io/canner/wren-engine:latest
    restart: on-failure
    expose:
      - "5555"      # engine API port (internal)
      - "5556"      # SQL / engine port
    volumes:
      - wren-data:/usr/src/app/etc
    depends_on:
      - wren-bootstrap
      - db

  ibis-server:
    image: ghcr.io/canner/wren-engine-ibis:latest
    restart: on-failure
    expose:
      - "5560"
    environment:
      - WREN_ENGINE_ENDPOINT=http://wren-engine:5555
    depends_on:
      - wren-engine

  qdrant:
    image: qdrant/qdrant:v1.11.0
    restart: on-failure
    expose:
      - "6333"
    volumes:
      - qdrant-data:/qdrant/storage

  wren-ai-service:
    image: ghcr.io/canner/wren-ai-service:latest
    restart: on-failure
    expose:
      - "5557"
    ports:
      - "5557:5557"    # optional: exposes AI service to host
    environment:
      - PYTHONUNBUFFERED=1
      - CONFIG_PATH=/app/data/config.yaml
      - GENERATION_MODEL:${GENERATION_MODEL}
      - OPENAI_API_KEY:${OPENAI_API_KEY}
      - OPENAI_API_BASE:${OPENAI_API_BASE}
      - TELEMETRY_ENABLED:${TELEMETRY_ENABLED}
      - CLICKHOUSE_HOST:db
      - CLICKHOUSE_HTTP_PORT:8123
      - CLICKHOUSE_USER:default
      - CLICKHOUSE_PASSWORD:
    volumes:
      - ./wren/config.yaml:/app/data/config.yaml:ro
      - wren-data:/app/data
    depends_on:
      - wren-engine
      - qdrant
      - db

  wren-ui:
    image: ghcr.io/canner/wren-ui:latest
    restart: on-failure
    ports:
      - "3000:3000"   # change if you already use 3000
    environment:
      - WREN_ENGINE_ENDPOINT=http://wren-engine:5555
      - WREN_AI_ENDPOINT=http://wren-ai-service:5557
      - DB_TYPE=sqlite
      - SQLITE_FILE=/app/data/db.sqlite3
      - GENERATION_MODEL=${GENERATION_MODEL}
    volumes:
      - wren-data:/app/data
    depends_on:
      - wren-ai-service
      - wren-engine

volumes:
#  ollama_data:
  cube-store:
  wren-data:
  qdrant-data:
