# -------------------------
# WREN AI Add-on (append/merge with your existing docker-compose)
# -------------------------
services:
  wren-bootstrap:
    image: ghcr.io/canner/wren-bootstrap:latest
    restart: on-failure
    environment:
      DATA_PATH: /app/data
    volumes:
      - wren-data:/app/data
    command: /bin/sh /app/init.sh
    networks:
      - wren

  wren-engine:
    image: ghcr.io/canner/wren-engine:latest
    restart: on-failure
    expose:
      - "5555"      # internal engine API
      - "5556"      # internal SQL/engine port
    volumes:
      - wren-data:/usr/src/app/etc
    networks:
      - wren
    depends_on:
      - wren-bootstrap
      - db

  ibis-server:
    image: ghcr.io/canner/wren-engine-ibis:latest
    restart: on-failure
    expose:
      - "5560"
    environment:
      WREN_ENGINE_ENDPOINT: "http://wren-engine:5555"
    networks:
      - wren
    depends_on:
      - wren-engine

  qdrant:
    image: qdrant/qdrant:v1.11.0
    restart: on-failure
    expose:
      - "6333"
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - wren

  wren-ai-service:
    image: ghcr.io/canner/wren-ai-service:latest
    restart: on-failure
    ports:
      - "5557:5557"    # expose AI service to host if helpful
    environment:
      PYTHONUNBUFFERED: "1"
      CONFIG_PATH: "/app/data/config.yaml"

      # Model provider / runtime (from .env)
      GENERATION_MODEL: ${GENERATION_MODEL}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_API_BASE: ${OPENAI_API_BASE}
      TELEMETRY_ENABLED: ${TELEMETRY_ENABLED}

      # optional analytics
      POSTHOG_API_KEY: ${POSTHOG_API_KEY}
      POSTHOG_HOST: ${POSTHOG_HOST}

      # ClickHouse info (useful if service expects them)
      CLICKHOUSE_HOST: db
      CLICKHOUSE_HTTP_PORT: "8123"
      CLICKHOUSE_USER: "default"
      CLICKHOUSE_PASSWORD: ""
    volumes:
      - ./wren/config.yaml:/app/data/config.yaml:ro
      - wren-data:/app/data
    networks:
      - wren
    depends_on:
      - wren-engine
      - qdrant
      - db

  wren-ui:
    image: ghcr.io/canner/wren-ui:latest
    restart: on-failure
    ports:
      - "3000:3000"
    environment:
      WREN_ENGINE_ENDPOINT: "http://wren-engine:5555"
      WREN_AI_ENDPOINT: "http://wren-ai-service:5557"
      DB_TYPE: "sqlite"
      SQLITE_FILE: "/app/data/db.sqlite3"
      GENERATION_MODEL: ${GENERATION_MODEL}
    volumes:
      - wren-data:/app/data
    networks:
      - wren
    depends_on:
      - wren-ai-service
      - wren-engine

networks:
  wren:
    driver: bridge

volumes:
  wren-data:
  qdrant-data:
